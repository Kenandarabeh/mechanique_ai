"use client";

import { AssistantRuntimeProvider, useAssistantRuntime } from "@assistant-ui/react";
import {
  useChatRuntime,
  AssistantChatTransport,
} from "@assistant-ui/react-ai-sdk";
import { useAuth, UserButton } from "@clerk/nextjs";
import { Thread } from "@/components/assistant-ui/thread";
import {
  SidebarInset,
  SidebarProvider,
  SidebarTrigger,
} from "@/components/ui/sidebar";
import { ThreadListSidebar } from "@/components/assistant-ui/threadlist-sidebar";
import { Separator } from "@/components/ui/separator";
import { useEffect, useRef, useState } from "react";

// ChatSaver is no longer needed - saving happens in API route
const ChatSaver = () => {
  return null;
};

interface AssistantProps {
  chatId?: string;
}

export const Assistant = ({ chatId }: AssistantProps = {}) => {
  const { getToken } = useAuth();
  const [isLoadingMessages, setIsLoadingMessages] = useState(false);
  
  console.log("ğŸ”· Assistant Component - ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ÙƒÙˆÙ†");
  console.log("API URL:", "/api/chat");
  console.log("Chat ID:", chatId || "Ø¬Ø¯ÙŠØ¯");

  const runtime = useChatRuntime({
    transport: new AssistantChatTransport({
      api: "/api/chat",
      headers: async () => {
        const token = await getToken();
        return {
          Authorization: `Bearer ${token}`,
        };
      },
      body: {
        chatId,
      },
    }),
  });

  // Load chat messages if chatId is provided
  useEffect(() => {
    console.log("ğŸ”„ useEffect triggered - chatId:", chatId, "runtime:", !!runtime);
    if (chatId && runtime && !isLoadingMessages) {
      console.log("â–¶ï¸ Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©...");
      loadChat(chatId);
    } else {
      console.log("â­ï¸ Ù„Ù† ÙŠØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„:", { chatId, hasRuntime: !!runtime, isLoadingMessages });
    }
  }, [chatId]);

  const loadChat = async (id: string) => {
    try {
      console.log("ï¿½ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©:", id);
      console.log("ğŸ“¡ URL:", `/api/chats/${id}`);
      
      const response = await fetch(`/api/chats/${id}`);
      console.log("ğŸ“¡ Response status:", response.status, response.statusText);
      
      if (response.ok) {
        const chat = await response.json();
        console.log("âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©:", chat);
        console.log("âœ… Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„:", chat.messages?.length);
        console.log("âœ… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„:", chat.messages);
        
        // Convert to assistant-ui format
        const messages = chat.messages.map((msg: any) => {
          console.log("ğŸ”„ ØªØ­ÙˆÙŠÙ„ Ø±Ø³Ø§Ù„Ø©:", msg);
          return {
            id: msg.id,
            role: msg.role,
            content: [{ type: "text", text: msg.content }],
          };
        });
        
        console.log("âœ… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø­ÙˆÙ„Ø©:", messages);
        
        // Import messages into runtime
        console.log("â–¶ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¥Ù„Ù‰ runtime...");
        runtime.thread.import({ messages });
        console.log("âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ù†Ø¬Ø§Ø­!");
      } else {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Response:", response.status, await response.text());
      }
    } catch (error) {
      console.error("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©:", error);
      console.error("âŒ Error details:", error);
    }
  };

  console.log("âœ“ Runtime ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø¨Ù†Ø¬Ø§Ø­");

  return (
    <AssistantRuntimeProvider runtime={runtime}>
      <ChatSaver />
      <SidebarProvider defaultOpen={true}>
        <div className="flex h-dvh w-full flex-row-reverse">
          <ThreadListSidebar />
          <SidebarInset className="flex-1">
            <header className="flex h-16 shrink-0 items-center gap-2 border-b px-4 bg-gradient-to-l from-blue-600/10 to-blue-500/5">
              <div className="flex items-center gap-3 flex-1">
                <div className="flex items-center gap-2">
                  <svg className="w-8 h-8 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                  </svg>
                  <div>
                    <h1 className="font-bold text-lg text-blue-600">ğŸ”§ Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒ Ø§Ù„Ø°ÙƒÙŠ</h1>
                    <p className="text-xs text-muted-foreground">Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ Ù„ØµÙŠØ§Ù†Ø© ÙˆØ¥ØµÙ„Ø§Ø­ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</p>
                  </div>
                </div>
              </div>
              
              {/* User Profile & Logout */}
              <div className="flex items-center gap-3">
                <UserButton 
                  appearance={{
                    elements: {
                      avatarBox: "w-10 h-10",
                      userButtonPopoverCard: "shadow-xl",
                    }
                  }}
                  afterSignOutUrl="/sign-in"
                  showName={false}
                />
                <Separator orientation="vertical" className="ml-2 h-4" />
                <SidebarTrigger />
              </div>
            </header>
            <div className="flex-1 overflow-hidden">
              <Thread />
            </div>
          </SidebarInset>
        </div>
      </SidebarProvider>
    </AssistantRuntimeProvider>
  );
};
